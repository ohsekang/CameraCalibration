# Camera Extrinsic Calibration
> 카메라 외부 기준 보정
  
'extrinsicCalib.py'를 사용하면 카메라의 **외부 파라미터 보정**을 수행하고, (동일한 보정 플레이트가 포함된) 두 뷰의 **변환**을 구현하고, **유니-반응 변환 행렬**을 생성할 수 있습니다. 
(회전 변환 행렬 RT는 도구에서 'decomposeH.py'를 사용하여 구할 수 있습니다).  
자세한 코멘트는 'extrinsicCalib.ipynb'에 포함되어 있으며, Jupyter Notebook에서 직접 코드를 실행할 수도 있습니다.   
  
## Requirement
opencv(>=3.4.2) numpy(>=1.19.2)  
  
## Background

지상을 동시에 촬영하는 **UAV 카메라**와 **차량 탑재 서라운드 뷰 카메라**의 캘리브레이션 플레이트를 기반으로 차량 탑재 카메라의 **외부 파라미터 캘리브레이션**을 수행합니다.  
차량 탑재 카메라에서 드론 카메라로 **단일 확률 변환 행렬**을 생성하여 **조감도**(즉, 차량 탑재 카메라 시점에서 드론 시점으로의 변환)를 달성합니다.  

## Work Flow    
- 캘리브레이션 보정판을 바닥에 놓고 고정합니다.  
- 캘리브레이션 보드는 다양한 위치와 시점의 고정 카메라(예: 차량에 장착된 카메라 4대와 드론 카메라 1대)로 촬영합니다 (보드가 선명하고 완전한지 확인하기 위해).  
- 캘리브레이션 플레이트를 이동하고 해당 이미지의 추가 세트를 촬영합니다(필수는 아님)* (각 카메라에서 최소 한 세트의 이미지가 있으면 캘리브레이션을 완료할 수 있습니다).  
- 각 카메라의 내부 캘리브레이션에 따라 왜곡을 제거하기 위해 이미지를 사전 처리합니다.  
- 두 카메라의 해당 이미지는 소스 이미지(img_src)와 대상 이미지(img_dst)입니다.  
- 두 카메라의 해당 이미지는 소스 이미지(img_src)와 타겟 이미지(img_dst)입니다. 두 카메라의 해당 이미지는 extrinsicCalib.py를 사용하여 소스 이미지로 변환되고, 이후 스티칭을 위해 결과 모노 안정성 매트릭스 H가 저장됩니다.    
  
참고: 드론이 **한 번만 촬영**할 수 있도록 가급적 차량 주변에 **여러 개의 보정 플레이트**를 사용하고, 동일한 보정 플레이트는 **최소 4개**(앞, 뒤, 좌, 우에 각각 1개씩)를 사용하는 것을 권장합니다;  
조명 환경과 캘리브레이션 플레이트 거리를 고려하여 서라운드 뷰 카메라에서 캘리브레이션 플레이트가 선명하고 **모서리 지점을 쉽게 감지**할 수 있는지 확인합니다;  
각 카메라는 먼저 내부 레퍼런스로 보정해야 하며, **내부 레퍼런스를 변경하면 외부 레퍼런스를 다시 보정**해야 합니다('intrinsicCalib.py' 참조);  
디앨리어싱 전처리에 적합한 **초점 거리 및 크기 배율**을 선택하여 **적절한 시야각**(네 대의 카메라가 시각적으로 겹치는 영역을 결정)과 **모서리 감지**(플롯에서 플레이트의 크기 보정)를 보장합니다;  
올바른 **카메라 해상도**와 최종 **조감도**의 크기를 선택하면 최종 **정밀도**(모서리 지점을 쉽게 감지하고 정확도를 높이기 위한 큰 해상도)와 **속도**(변환의 실시간 특성) 사이에서 절충해야 할 사항이 결정됩니다;  
다음 섹션에서 설명하는 것처럼 프로그램은 이미지를 이동 및 확대/축소하여 균일한 조감도를 확보하고 오류를 줄일 수 있도록 UAV를 최대한 안정적으로 유지합니다.  
  

## Quick Start
### extrinsicCalib.py 
> 카메라 외부 기준 보정  
  
입력된 **소스 이미지**와 **타겟 이미지**가 보정 및 **왜곡**되었는지 확인하시기 바랍니다('intrinsicCalib.py' 참조).  
또한 소스 이미지와 타겟 이미지의 **순서**가 서로 일치하는지** 확인하세요.   
```
python extrinsicCalib.py
```
argparse를 통해 더 많은 매개변수를 입력하거나 '-h' 또는 '--help'를 사용하여 모든 매개변수 정보를 확인할 수 있으며, **각 매개변수의 기본값을 참고하세요**.
```
python extrinsicCalib.py -h
```

| Argument   | Type | Default   | Help                                              | 참고           |
|:-----------|:----:|:---------:|:--------------------------------------------------| :--------------|
| -id        | int  | 1         | Camera ID                                         | 카메라 번호       |
| -path      | str  | ./data/   | Input Video/Image Path                            | 입력 이미지 경로   |
| -bw        | int  | 7         | Chess Board Width (corners number)                | 보드 그리드 너비(안쪽 모서리의 포인트 수) |
| -bh        | int  | 6         | Chess Board Height (corners number)               | 보드 그리드의 높이(안쪽 모서리의 포인트 수) |
| -src       | str  | img_src   | Source Image File Name Prefix (eg.: img_src)      | 소스 이미지 파일명 접두사 |
| -dst       | str  | img_dst   | Destionation Image File Name Prefix (eg.: img_dst)| 타겟 이미지 파일 이름 접두사 |
| -size      | int  | 10        | Scaled Chess Board Square Size (image pixel)      | 스케일링된 보드의 각 셀 가장자리 길이가 차지하는 다이어그램의 픽셀 크기 |
| -subpix_s  | int  | 3         | Corners Subpix Region of img_src                  | 소스 이미지 하위 픽셀 최적화를 위한 검색 픽셀 범위 |
| -subpix_d  | int  | 3         | Corners Subpix Region of img_dst                  | 대상 이미지의 서브픽셀 최적화를 위한 검색 픽셀 범위 |
| -center    | bool | False     | Center Image Manually (Ture/False)                | 대상 이미지를 가운데에 배치할지 여부|
| -scale     | bool | False     | Scale Image to Fix Board Size (Ture/False)        | 대상 이미지 크기 조정 여부 |
| -store     | bool | False     | Store Centerd/Scaled Images (Ture/False)          | 대상 이미지 저장 여부(센터링 및 크기 조정 후) |
| -store_path| str  | ./data/   | Path to Store Centerd/Scaled Images               | 저장 경로       |  
  
-----------------------------------------------------------------------------------  
  
프로그램은 '-path' 아래에 '-src' 및 '-dst'라는 이름이 포함된 모든 이미지를 읽어들여 순서대로 하나씩 변환합니다.  
'center' 및 '-scale'이 True로 설정되어 있으면 대상 이미지인 img_dst의 중앙에 배치되고 크기가 조정됩니다.  
  
이미지가 중앙에 배치된 경우:  
- 차량 센터를 직접 **클릭**할 수 있습니다.  
- 또는 **마우스 왼쪽 버튼을 누른** 채로 **직사각형 상자**를 그려 차량의 틀을 잡고 자동으로 중앙 지점으로 돌아옵니다. 
- 중심점 좌표와 (y/n) 옵션이 표시되며, y를 눌러 중앙 설정을 완료하고 n을 눌러 다시 선택합니다.  
- 확인 메시지가 표시되면 중앙에 위치한 이미지가 표시되고 ESC를 눌러 닫습니다.  
![center.jpg](https://i.loli.net/2021/06/22/5twSk8rfu2OZcCd.png)     
  
이미지 크기 조정 시:  
- 프로그램은 먼저 대상 이미지 img_dst에서 모서리 좌표를 추출하고 보드 사각형의 평균 픽셀 크기를 계산합니다.  
- 설정된 '-size' 값(즉, 이미지에서 최종 보정 보드의 바둑판 사각형의 픽셀 길이)을 기반으로 하며, 이 매개변수는 intrinsicCalib.py와는 다른 의미를 가짐에 유의합니다.  
모든 대상 이미지가 맵에서 보정 보드의 픽셀 크기가 같도록(즉, 드론의 높이가 같도록) 이미지의 크기를 조정하는 배율을 계산하고, 이를 사용하여 **배율**을 계산할 수 있습니다. 
- 배율 조정된 이미지 자르기 또는 가장자리 채우기  
- 배율 이미지 표시, ESC 끄기  
예를 들어, '크기'의 기본 설정은 10이며, 실제 보정 플레이트의 프레임당 크기가 100mm인 경우, 즉 최종 보정 플레이트의 각 프레임이 이미지에서 10 픽셀을 차지하는 경우 스케일은 1 픽셀 : 10mm입니다.    
  
이미지 세트를 읽을 때마다 프로그램은 단일 응답 행렬 계산(총 데이터 양이 지속적으로 누적됨)을 수행하고 변환된 이미지를 표시하고 마지막으로 해당 H-파일을 저장합니다.    
  
-----------------------------------------------------------------------------------  
  
특히 차량에 장착된 서라운드 뷰 카메라의 외부 기준 보정 시에는 더욱 그렇습니다:  
- 최종 조감도가 서로 연결되도록 하려면 가능한 한 많은 보정 플레이트(최소 4개)와 동일한 드론 이미지를 사용해야 합니다.  
- 드론 이미지의 경우, 이미지 도구를 사용하여 차량의 전면이 앞에 올 때까지 **회전**하고 **수직**으로 유지한 다음 최종 조감도 이미지의 필요한 **비율**로 **자르고 최종 조감도 이미지의 크기에 맞게 **이미지 크기를 조정**하는 등 수동으로 사전 처리해야 합니다.
(이 드론 이미지는 조감도 스티칭을 변환하는 데 이상적인 참조 이미지이기도 합니다.)  
- 먼저, 이 코드를 사용하여 드론 이미지의 중심과 크기를 조정하고 저장**합니다. 즉, '-center' '-scale' '-store'를 'True'로 설정하여 공식적으로 보정된 대상 이미지 img_dst를 얻습니다.
- 하나의 **센터 스케일링 작업**만 접합하는 효과를 보장하기 위해 이미지로 균일하게 보정 한 후 그림의 4 개의 보정 플레이트에 대해 그림 도구로 4 개의 사본을 ** 복사하여 그중 3 개를 덮을 수 있습니다.
- 네 개의 링보기의 원본 이미지의 왜곡을 제거하고, 시야를 늘리기 위해 초점 거리를 적절하게 줄여 카메라 사이의 공통 시야 영역을 보장하여 코너 감지율과 정확도를 향상시키기 위해 적절한 크기를 늘릴 수 있습니다.  
- 모서리 지점을 감지할 수 없는 이미지의 경우 사진 도구를 사용하여 **노출, 대비** 등을 수동으로 조정할 수 있습니다. 가장 중요한 것은 **이미지를 수집할 때 좋은 조명 환경, 적절한 거리, 적절한 카메라 해상도**를 확보하는 것이며, 이는 이미지 수집 시 intrinsicCalib.py를 사용하여 테스트하고 보정 적용 시 **적절한 초점 크기**를 선택하면 됩니다. 스케일링 계수**.    
- 네 세트의 카메라 및 드론 이미지 각각에 대해 프로그램을 실행하여 해당 계산된 단선 행렬 H를 구하고 다음을 저장합니다. 
  
**사진 처리 절차**를 저장합니다:  
![exCalib_process.png](https://i.loli.net/2021/06/22/NiCjQDTk82HeqWA.png)  
  
**변환 결과**:
![exCalib_result.jpg](https://i.loli.net/2021/06/22/5fMmcxTuZ2aIUyN.png)  
   
`2021.6 ZZH`  
  
  
